#install packages
install.packages('raster')

#load packages
require(raster)

##load shapefile
br <- shapefile('Brasil')

##load function to transform species occurrences into spp-by-site matrix
source('splistToMatrix.R')

##load species occurrences matrix and check dimensions
d <- read.csv(file.choose(), header = T, sep = ',')
dim(d)

##define species
sp <- as.vector(unique(d$Species))

##rasterize Brazil's delimitation. Change resolution accordingly; 0.5 = c.100km
r <- raster(br, res = 0.5)

##extract latlongs and name columns
latlong <- coordinates(r)
colnames(latlong) <- c('Long10', 'Lat10')

##create spp-by-site matrix and name latlong rows
spp <- splistToMatrix(d, sp, r)
dim(spp)
rownames(latlong) <- rownames(spp)

##delete sites with no species and check dimensions
uni <- apply(spp, 1, sum)
spp <- spp[which(uni > 0), ]
dim(spp)

##prune latlong sites to match spp matrix
latlong <- latlong[which(rownames(latlong)%in%rownames(spp)), ]

##compute richness
alpha <- as.matrix(apply(spp, 1, sum))
colnames(alpha) <- 'alpha'
dim(alpha)#check dimensions


#compute endemism
tmp <- apply(spp, 2, sum)
spp2 <- spp[, which(tmp == 1)]
dim(spp2)#check dimensions
uni <- as.matrix(apply(spp2, 1, sum))
colnames(uni) <- 'endemism'
dim(uni)

##merge objects
mapping <- as.data.frame(cbind(latlong, alpha, uni))

#rasterize and plot alpha for  Minas Gerais
attach(mapping)
d <- data.frame(Long10, Lat10, alpha)
coordinates(d)=~Long10+Lat10
proj4string(d)=CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")

r.alpha <- raster(d, res  = 0.5)
r.alpha <- rasterize(d, r.alpha, field = d@data[,1])
plot(r.alpha)

##rasterize endemism
d <- data.frame(Long10, Lat10, endemism)
coordinates(d)=~Long10+Lat10
proj4string(d)=CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")

r.endemism <- raster(d, res  = 0.5)
r.endemism <- rasterize(d, r.endemism, field = d@data[,1])

##plot MG results to working directory
tiff('diversity.tiff', height = 15, width = 30,
	unit = 'cm', res = 600)
par(mfrow = c(1,2))

plot(mg, border = 'white')
plot(r.alpha, main = 'Riqueza', add = T)
plot(mg, add = T)

plot(mg, border = 'white')
plot(r.endemism, 'Endemismo', add = T)
plot(mg, add = T)

dev.off()
